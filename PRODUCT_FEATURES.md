# iBooks Notes Sync 产品功能清单（草案）

## 1. 产品目标
- 帮用户把 Apple Books 里的阅读标注，稳定同步到本地知识库（先以 Markdown 文件为目标）。
- 以 CLI 形态优先，强调可控、可预览、可重复执行。

## 2. 目标用户
- 重度阅读用户（在 Apple Books 做高亮/笔记）。
- 有本地知识管理习惯的用户（Obsidian 或其他 Markdown 工作流）。

## 3. MVP（第一版必须有）
- [x] 首次初始化（生成配置）
- [x] 健康检查（doctor：环境/权限/数据可读性）
- [x] 列出可同步书籍（list-books：输出书名、作者、格式 EPUB/PDF，并在有数据时输出出版商）
- [x] 执行同步（sync：全量重建，先在临时目录生成，成功后替换工具管理目录）
- [x] 预演模式（dry-run：只输出变更计划，永不写入、永不替换）
- [x] 失败回滚（任一步骤失败时，不影响当前正式输出）
- [x] 基础日志输出（成功/失败/跳过数）

## 4. 第一版范围说明（对外口径）
- [x] 支持同步 Apple Books 中“可见的标注内容”
- [x] 仅支持 macOS
- [x] 仅支持 CLI（不做 GUI，不做插件）

### 4.1 EPUB（需求展开）
- [x] 第一版同步字段（书籍）：书名、作者、出版商（有则输出）、格式（EPUB）、源文件路径
- [x] 第一版同步字段（标注）：高亮文本、笔记文本（有则输出）、定位信息（epubcfi）、创建时间
- [x] 输出格式：一本书一个 Markdown 文件，文件头输出书籍信息，正文按“标注时间升序”输出
- [x] 标注展示规则：每条标注固定包含高亮文本；笔记和定位信息为可选块（有值才展示）
- [x] 重复执行规则：全量重建后结果一致（同一本书内顺序稳定，不因重复运行产生抖动）
- [x] 异常提示：无权限读取 iBooks 数据时给出权限提示和处理建议
- [x] 异常提示：书籍存在但无标注时显示“0 条标注”，不视为失败
- [x] 异常提示：单本书解析失败时跳过该书并汇总到失败列表，不阻断其他书

### 4.2 PDF（需求展开）
- [x] 第一版同步字段（书籍）：书名、作者、出版商（有则输出）、格式（PDF）、源文件路径
- [x] 输出结构：按“页”组织内容，不使用章节分组
- [x] 页面展示：仅为“有标注的页”生成截图，避免全书截图
- [x] 标注可视化：在页截图上绘制高亮/标注区域，并叠加编号（1,2,3...）
- [x] 笔记列表：在截图下按编号输出对应笔记，支持“高亮笔记”和“页面标注”两类
- [x] 编号规则：同一页按位置稳定排序（上到下、左到右），保证重复同步编号不抖动
- [x] 坐标兜底：无法获取标注坐标时不绘制框，仅输出“无定位笔记”列表
- [x] 差异化规则：EPUB 走文本/章节流；PDF 走页面/截图流
- [x] Beta 策略：PDF 默认开启 Beta，同步结果中明确标注“PDF Beta”并提示可能不完整
- [x] 异常提示：PDF 标注解析异常时不影响 EPUB 同步结果，最终摘要单独列出 PDF 异常数量

### 4.3 Obsidian 内单本书视觉形态（已定稿）
- [x] 生成一个总览 `index` 文件，列出所有可同步书籍
- [x] 每本书生成一个独立 Markdown 文件（避免不同书内容混杂）
- [x] 单本书内按章节分组展示标注内容（更接近阅读流）
- [x] `index` 固定字段：书名、作者、格式、标注数、最后同步时间
- [x] 当章节信息缺失时，自动归入“未分章”分组（不因结构不完整而失败）

## 5. 体验要求（第一版）
- [x] 默认命令简单：`sync` 即可运行
- [x] 错误提示可读（告诉用户下一步怎么处理）
- [x] 输出摘要：新增/更新/跳过/失败
- [x] 支持按书籍过滤同步（避免一次全量）

## 6. 先不做（Non-goals）
- [ ] 不做实时监听同步
- [ ] 不做云端账号体系
- [ ] 不做跨设备同步
- [ ] 不做复杂模板系统
- [ ] 不做 Obsidian 插件形态

## 7. 下一步待你拍板
- [ ] 第一版同步目标：仅 Obsidian Vault，还是“任意本地目录”
- [ ] 文件组织策略：一本书一个文件，还是按日期/作者分目录
- [ ] 冲突策略：覆盖、追加、还是保守跳过
- [ ] PDF Beta 是否默认开启
